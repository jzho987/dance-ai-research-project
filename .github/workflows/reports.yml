name: Build Reports

on:
  push:
    branches: [ report/test ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # - name: Git branch name
      #   id: git-branch-name
      #   uses: EthanSK/git-branch-name-action@v1
        
      - uses: actions/checkout@v2

      - name: Install dependencies
        run: sudo apt-get install texlive-latex-extra make

      # - name: Find changed files in reports folder
      #   id: changed_files
      #   run: |
      #     git fetch origin report/test
      #     git diff --name-only origin report/test HEAD | grep -E '^reports/.*\.(tex|bib)$' > changed_files.txt

      # - name: Check if there are any changed files
      #   run: |
      #       if [[ ! -s changed_files.txt ]]; then
      #         exit 0;
      #       fi

      # - name: Build reports
      #   run: |
      #     while IFS= read -r file; do
      #       cd reports && make compile_latex name=${file##reports/}
      #     done < changed_files.txt
      
      - name: Build reports - init
        run: |
          ls
          cd reports
          pdflatex literature_review.tex

      - name: Build reports - bib
        run: |
          ls
          cd reports
          bibtex literature_review

      - name: Build reports - final 1
        run: |
          ls
          cd reports
          pdflatex literature_review.tex

      - name: Build reports - finish
        run: |
          ls
          cd reports
          pdflatex literature_review.tex

      - name: Add and commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git stash --all
          git checkout reports
          git status
          git status
          git apply
          git add -f reports/*.pdf
          git commit -m "Build reports (SHA: ${{ github.sha }})" || true

      - name: Push changes to reports branch
        uses: actions/checkout@v4
        with:
          ref: 'refs/heads/reports'
          github-token: ${{ secrets.GITHUB_TOKEN }}
